<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="theme-color" content="#1e293b">
  <title>الموثق الذكي - أ. عمر العطاس</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Cairo', 'sans-serif'] },
          colors: { primary: '#1e293b', secondary: '#334155', accent: '#3b82f6' },
          cursor: { 'grab': 'grab', 'grabbing': 'grabbing' }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Cairo', sans-serif; overscroll-behavior: none; }
    .preview-bg {
       background-color: #f1f5f9;
       background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
       background-size: 20px 20px;
    }
    .draggable-item { touch-action: none; user-select: none; }
    .active-element {
        outline: 2px dashed #3b82f6;
        outline-offset: 2px;
        background-color: rgba(59, 130, 246, 0.1);
    }
    .repeated-badge {
        position: absolute; top: -12px; right: -12px;
        background: #f59e0b; color: white; font-size: 10px; font-weight: bold;
        padding: 2px 8px; border-radius: 12px; z-index: 60;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;
    }
    .library-scroll::-webkit-scrollbar { height: 6px; }
    .library-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    /* Animation */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-up { animation: fadeIn 0.4s ease-out forwards; }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased overflow-hidden">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useRef, useEffect } = React;

    // ==========================================
    // ⬇️⬇️ بياناتك الشخصية المحدثة ⬇️⬇️
    // ==========================================
    const DEVELOPER = {
        name: "أ. عمر بن حسن العطاس",
        twitterHandle: "@omer_attas", 
        twitterUrl: "https://x.com/omer_attas"
    };
    // ==========================================

    // --- ICONS ---
    const Icons = {
      Badge: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78 4 4 0 0 1 0-6.74Z"/></svg>,
      Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
      Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
      Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
      ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
      Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
      Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
      Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
      Twitter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>,
      Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
    };

    // --- RENDER ENGINE ---
    const renderPage = async (pdf, pageNumber) => {
      const page = await pdf.getPage(pageNumber);
      const scale = 2.0; 
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d', { willReadFrequently: true });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      return {
        dataUrl: canvas.toDataURL('image/jpeg', 0.9),
        width: viewport.width,
        height: viewport.height,
        aspectRatio: viewport.width / viewport.height,
        originalFormat: [viewport.width / scale, viewport.height / scale]
      };
    };

    // --- WELCOME MODAL COMPONENT ---
    const WelcomeModal = ({ onClose }) => {
      return (
        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
           <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-fade-up">
              <div className="bg-slate-800 p-6 text-white text-center">
                 <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Icons.Badge />
                 </div>
                 <h2 className="text-2xl font-bold">برنامج الموثق الذكي</h2>
                 <p className="text-slate-300 text-sm mt-1">تطوير: {DEVELOPER.name}</p>
              </div>
              
              <div className="p-8 space-y-6">
                 <div className="space-y-4">
                    <div className="flex items-start gap-4">
                       <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">1</div>
                       <div>
                          <h4 className="font-bold text-gray-800">رفع الملف</h4>
                          <p className="text-sm text-gray-500">ارفع ملف PDF (شهادات، خطابات) بأي عدد صفحات.</p>
                       </div>
                    </div>
                    <div className="flex items-start gap-4">
                       <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">2</div>
                       <div>
                          <h4 className="font-bold text-gray-800">إضافة التوقيع</h4>
                          <p className="text-sm text-gray-500">أضف صورة التوقيع أو الختم، واحفظها في المكتبة للاستخدام الدائم.</p>
                       </div>
                    </div>
                    <div className="flex items-start gap-4">
                       <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">3</div>
                       <div>
                          <h4 className="font-bold text-gray-800">التكرار الذكي</h4>
                          <p className="text-sm text-gray-500">اضغط "تكرار على الكل" ليتم توقيع 100 شهادة في ثانية واحدة.</p>
                       </div>
                    </div>
                 </div>

                 <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl font-bold transition-all shadow-lg">
                    ابدأ الاستخدام
                 </button>
                 
                 <div className="text-center pt-2 border-t">
                    <a href={DEVELOPER.twitterUrl} target="_blank" className="inline-flex items-center gap-2 text-sm text-blue-500 hover:text-blue-700 font-medium dir-ltr">
                       <Icons.Twitter /> {DEVELOPER.twitterHandle}
                    </a>
                 </div>
              </div>
           </div>
        </div>
      );
    };

    const App = () => {
      const [showWelcome, setShowWelcome] = useState(true);
      const [step, setStep] = useState(1); 
      const [file, setFile] = useState(null);
      const [pages, setPages] = useState([]); 
      const [currentPage, setCurrentPage] = useState(0);
      const [processingStats, setStats] = useState({ current: 0, total: 0 });
      const [stamps, setStamps] = useState([]); 
      const [activeStampId, setActiveStampId] = useState(null);
      const [library, setLibrary] = useState(() => {
        const saved = localStorage.getItem('my_stamps_library');
        return saved ? JSON.parse(saved) : [];
      });
      const [dragState, setDragState] = useState({ isDragging: false, startX: 0, startY: 0, initialStampX: 0, initialStampY: 0 });
      const imageContainerRef = useRef(null);
      const fileInputRef = useRef(null);

      // Core Logic
      const addToLibrary = (src) => {
        if (library.includes(src)) return alert("موجود مسبقاً");
        try {
          const newLib = [...library, src];
          setLibrary(newLib);
          localStorage.setItem('my_stamps_library', JSON.stringify(newLib));
          alert("تم الحفظ في المكتبة");
        } catch (e) { alert("الذاكرة ممتلئة"); }
      };

      const removeFromLibrary = (index) => {
        if (!confirm("حذف؟")) return;
        const newLib = library.filter((_, i) => i !== index);
        setLibrary(newLib);
        localStorage.setItem('my_stamps_library', JSON.stringify(newLib));
      };

      const addFromLibrary = (src) => {
        const newStamp = { id: Date.now(), src, x: 50, y: 50, width: 20, pageIndex: currentPage, isRepeated: false };
        setStamps(prev => [...prev, newStamp]);
        setActiveStampId(newStamp.id);
      };

      const handleReset = () => {
        if (stamps.length > 0 && !confirm("هل أنت متأكد من البدء من جديد؟")) return;
        setFile(null); setPages([]); setStamps([]); setActiveStampId(null); setStep(1); setCurrentPage(0);
      };

      const handleFileSelect = (e) => { if (e.target.files?.[0]) setFile(e.target.files[0]); };

      const startLoading = async () => {
        if (!file) return;
        setStep(2);
        try {
          const arrayBuffer = await file.arrayBuffer();
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/', cMapPacked: true });
          const pdf = await loadingTask.promise;
          const numPages = pdf.numPages;
          const loadedPages = [];
          for (let i = 1; i <= numPages; i++) {
            setStats({ current: i, total: numPages });
            const pageData = await renderPage(pdf, i);
            loadedPages.push(pageData);
          }
          setPages(loadedPages);
          setStep(3);
        } catch (err) { alert("خطأ: " + err.message); setStep(1); }
      };

      const handleAddStampFile = (e) => {
        if (e.target.files?.[0]) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const src = ev.target.result;
            const newStamp = { id: Date.now(), src, x: 50, y: 50, width: 20, pageIndex: currentPage, isRepeated: false };
            setStamps(prev => [...prev, newStamp]);
            setActiveStampId(newStamp.id);
            e.target.value = '';
          };
          reader.readAsDataURL(e.target.files[0]);
        }
      };

      const updateActiveStamp = (key, value) => {
        if (!activeStampId) return;
        setStamps(prev => prev.map(s => s.id === activeStampId ? { ...s, [key]: value } : s));
      };

      const deleteActiveStamp = () => {
        if (!activeStampId) return;
        setStamps(prev => prev.filter(s => s.id !== activeStampId));
        setActiveStampId(null);
      };

      const handlePointerDown = (e, id) => {
        e.stopPropagation(); e.preventDefault();
        const stamp = stamps.find(s => s.id === id);
        if (!stamp) return;
        setActiveStampId(id);
        setDragState({ isDragging: true, startX: e.clientX, startY: e.clientY, initialStampX: stamp.x, initialStampY: stamp.y });
      };

      const handlePointerMove = useCallback((e) => {
        if (!dragState.isDragging || !activeStampId || !imageContainerRef.current) return;
        e.preventDefault();
        const rect = imageContainerRef.current.getBoundingClientRect();
        const deltaX = e.clientX - dragState.startX;
        const deltaY = e.clientY - dragState.startY;
        const deltaPercentX = (deltaX / rect.width) * 100;
        const deltaPercentY = (deltaY / rect.height) * 100;
        let newX = Math.max(0, Math.min(100, dragState.initialStampX + deltaPercentX));
        let newY = Math.max(0, Math.min(100, dragState.initialStampY + deltaPercentY));
        setStamps(prev => prev.map(s => s.id === activeStampId ? { ...s, x: newX, y: newY } : s));
      }, [dragState, activeStampId]);

      const handlePointerUp = () => setDragState(prev => ({ ...prev, isDragging: false }));

      useEffect(() => {
        if (dragState.isDragging) {
          window.addEventListener('pointermove', handlePointerMove);
          window.addEventListener('pointerup', handlePointerUp);
        }
        return () => {
          window.removeEventListener('pointermove', handlePointerMove);
          window.removeEventListener('pointerup', handlePointerUp);
        };
      }, [dragState.isDragging, handlePointerMove]);

      const saveFinalPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'pt' }); 
        doc.deletePage(1);
        pages.forEach((pageData, index) => {
          const isLandscape = pageData.width > pageData.height;
          const [width, height] = pageData.originalFormat;
          doc.addPage([width, height], isLandscape ? 'l' : 'p');
          doc.addImage(pageData.dataUrl, 'JPEG', 0, 0, width, height);
          const pageStamps = stamps.filter(s => s.pageIndex === index || s.isRepeated);
          pageStamps.forEach(stamp => {
             const imgProps = doc.getImageProperties(stamp.src);
             const sigW = (stamp.width / 100) * width;
             const sigH = (imgProps.height * sigW) / imgProps.width;
             const sigX = (stamp.x / 100) * width - (sigW / 2);
             const sigY = (stamp.y / 100) * height - (sigH / 2);
             doc.addImage(stamp.src, 'PNG', sigX, sigY, sigW, sigH);
          });
        });
        doc.save(`Signed_${Date.now()}.pdf`);
      };

      const activeStampData = stamps.find(s => s.id === activeStampId);
      const currentPageData = pages[currentPage];

      return (
        <div className="h-screen flex flex-col bg-slate-200 overflow-hidden">
           {/* Welcome Modal */}
           {showWelcome && <WelcomeModal onClose={() => setShowWelcome(false)} />}

           {/* MAIN CONTENT */}
           <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
              
              {step === 1 && (
                <div className="w-full flex items-center justify-center p-4">
                  <div className="bg-white max-w-md w-full rounded-2xl shadow-xl p-8 space-y-6 text-center border-t-4 border-slate-800">
                      <div className="w-16 h-16 bg-slate-100 text-slate-800 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Badge /></div>
                      <h1 className="text-2xl font-bold text-gray-800">برنامج الموثق</h1>
                      <div className="space-y-4">
                        <label className="block bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-8 cursor-pointer hover:bg-slate-100 transition-colors">
                          <input type="file" onChange={handleFileSelect} accept="application/pdf" className="hidden" />
                          <Icons.Upload />
                          <span className="block mt-2 font-medium text-slate-600">{file ? file.name : "اضغط لاختيار ملف PDF"}</span>
                        </label>
                        {file && <button onClick={startLoading} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition-all">بدء العمل</button>}
                      </div>
                  </div>
                </div>
              )}

              {step === 2 && (
                <div className="w-full flex items-center justify-center">
                   <div className="text-center">
                      <div className="w-16 h-16 border-4 border-slate-800 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                      <h2 className="text-xl font-bold">جاري تجهيز الصفحات...</h2>
                      <p className="text-gray-500 dir-ltr">{processingStats.current} / {processingStats.total}</p>
                   </div>
                </div>
              )}

              {step === 3 && (
                <>
                  {/* SIDEBAR */}
                  <div className="w-full md:w-80 bg-white border-l border-gray-300 p-4 flex flex-col gap-4 z-20 shadow-lg overflow-y-auto h-1/3 md:h-full shrink-0">
                    <div className="flex items-center justify-between text-slate-800 font-bold text-lg border-b pb-2">
                      <span className="flex items-center gap-2"><Icons.Badge /> أدوات التحكم</span>
                      <button onClick={handleReset} className="text-xs bg-red-50 text-red-600 px-2 py-1 rounded flex items-center gap-1 hover:bg-red-100"><Icons.Refresh /> جديد</button>
                    </div>

                    {/* LIBRARY */}
                    <div className="bg-slate-50 rounded-xl p-3 border">
                      <h3 className="text-xs font-bold text-slate-500 mb-2">مكتبة التواقيع</h3>
                      {library.length === 0 ? <p className="text-[10px] text-center text-gray-400">فارغة</p> : (
                        <div className="flex gap-2 overflow-x-auto library-scroll pb-2">
                            {library.map((src, idx) => (
                              <div key={idx} className="relative shrink-0 group">
                                <img src={src} className="w-12 h-12 object-contain bg-white border rounded cursor-pointer hover:border-blue-500" onClick={() => addFromLibrary(src)} />
                                <button onClick={() => removeFromLibrary(idx)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100">×</button>
                              </div>
                            ))}
                        </div>
                      )}
                    </div>

                    <div className="space-y-3">
                      <button onClick={() => fileInputRef.current?.click()} className="w-full py-3 border-2 border-dashed border-slate-300 text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                        <input ref={fileInputRef} type="file" accept="image/*" onChange={handleAddStampFile} className="hidden" />
                        <Icons.Plus /> إضافة توقيع جديد
                      </button>

                      {activeStampId ? (
                        <div className="bg-slate-50 p-3 rounded-xl border space-y-3 animate-fade-in shadow-sm">
                          <div className="flex justify-between items-center text-sm font-bold text-gray-700 border-b pb-2">
                            <span>خصائص العنصر</span>
                            <button onClick={deleteActiveStamp} className="text-red-500 bg-red-50 p-1.5 rounded hover:bg-red-100"><Icons.Trash /></button>
                          </div>
                          <button onClick={() => addToLibrary(activeStampData.src)} className="w-full text-xs bg-slate-200 text-slate-700 py-1 rounded hover:bg-slate-300 flex items-center justify-center gap-1"><Icons.Save /> حفظ في المكتبة</button>
                          <button onClick={() => updateActiveStamp('isRepeated', !activeStampData.isRepeated)} className={`w-full py-2 px-3 rounded-lg text-xs font-bold flex items-center justify-between transition-colors ${activeStampData.isRepeated ? 'bg-amber-100 text-amber-800 border border-amber-200' : 'bg-white border text-gray-500 hover:bg-gray-50'}`}>
                            <span className="flex items-center gap-2"><Icons.Copy /> {activeStampData.isRepeated ? "التكرار مفعل" : "تكرار على الكل"}</span>
                            <div className={`w-8 h-4 rounded-full relative transition-colors ${activeStampData.isRepeated ? 'bg-amber-500' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-0.5 transition-all ${activeStampData.isRepeated ? 'left-4' : 'left-0.5'}`}></div></div>
                          </button>
                          <div>
                            <label className="text-xs text-gray-500 mb-1 block">الحجم</label>
                            <input type="range" min="5" max="80" value={activeStampData?.width || 20} onChange={(e) => updateActiveStamp('width', +e.target.value)} className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-700" />
                          </div>
                        </div>
                      ) : (
                        <div className="text-center text-gray-400 text-xs py-2 border rounded-xl bg-gray-50">حدد أي توقيع لتعديله</div>
                      )}
                    </div>

                    <div className="mt-auto space-y-2 pt-2 border-t">
                      <div className="flex items-center justify-between bg-slate-100 rounded-lg p-2">
                        <button onClick={() => setCurrentPage(p => Math.max(0, p - 1))} disabled={currentPage === 0} className="p-2 hover:bg-white rounded disabled:opacity-30"><Icons.ArrowRight /></button>
                        <span className="font-mono text-sm font-bold">ص {currentPage + 1} / {pages.length}</span>
                        <button onClick={() => setCurrentPage(p => Math.min(pages.length - 1, p + 1))} disabled={currentPage === pages.length - 1} className="p-2 hover:bg-white rounded disabled:opacity-30"><Icons.ArrowLeft /></button>
                      </div>
                      <button onClick={saveFinalPDF} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-md hover:bg-slate-700 flex items-center justify-center gap-2"><Icons.Download /> حفظ الملف</button>
                    </div>
                  </div>

                  {/* CANVAS PREVIEW AREA */}
                  <div className="flex-1 preview-bg relative overflow-auto flex items-center justify-center p-4 md:p-8 touch-none" onClick={() => setActiveStampId(null)}>
                    {currentPageData && (
                      <div ref={imageContainerRef} className="relative shadow-2xl bg-white transition-all select-none" style={{ width: currentPageData.aspectRatio > 1 ? '95%' : 'auto', height: currentPageData.aspectRatio > 1 ? 'auto' : '90vh', aspectRatio: `${currentPageData.aspectRatio}` }} onClick={(e) => e.stopPropagation()}>
                        <img src={currentPageData.dataUrl} className="w-full h-full object-contain pointer-events-none select-none block" draggable="false"/>
                        {stamps.filter(s => s.pageIndex === currentPage || s.isRepeated).map(stamp => (
                          <div key={stamp.id} onPointerDown={(e) => handlePointerDown(e, stamp.id)} style={{ position: 'absolute', left: `${stamp.x}%`, top: `${stamp.y}%`, width: `${stamp.width}%`, transform: 'translate(-50%, -50%)', zIndex: 50, cursor: 'grab' }} className={`draggable-item group rounded ${activeStampId === stamp.id ? 'active-element' : ''}`}>
                            <img src={stamp.src} className="w-full h-full object-contain pointer-events-none select-none" draggable="false" />
                            {stamp.isRepeated && <div className="repeated-badge">تكرار</div>}
                            {activeStampId === stamp.id && <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-blue-600 rounded-full shadow border border-white"></div>}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}
           </div>
           
           {/* FOOTER */}
           <div className="bg-slate-900 text-slate-400 text-xs py-2 px-4 flex justify-between items-center shrink-0">
              <div>برنامج الموثق الذكي © 2025</div>
              <div className="flex items-center gap-3">
                 <span>تطوير: {DEVELOPER.name}</span>
                 <a href={DEVELOPER.twitterUrl} target="_blank" className="hover:text-white transition-colors"><Icons.Twitter /></a>
              </div>
           </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>