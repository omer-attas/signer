<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="theme-color" content="#1e293b">
  <title>الموثق الذكي Pro - أ. عمر العطاس</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Cairo', 'sans-serif'],
            amiri: ['Amiri', 'serif'],
          },
          colors: { primary: '#1e293b', secondary: '#334155', accent: '#3b82f6' },
          cursor: { 'grab': 'grab', 'grabbing': 'grabbing' }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Cairo', sans-serif; overscroll-behavior: none; }
    .preview-bg {
       background-color: #f1f5f9;
       background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
       background-size: 20px 20px;
    }
    .draggable-item { touch-action: none; user-select: none; }
    .active-element {
        outline: 2px dashed #3b82f6;
        outline-offset: 4px;
    }
    .repeated-badge {
        position: absolute; top: -15px; right: -10px;
        background: #f59e0b; color: white; font-size: 10px; font-weight: bold;
        padding: 2px 8px; border-radius: 12px; z-index: 60;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;
    }
    .library-scroll::-webkit-scrollbar { height: 6px; }
    .library-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-up { animation: fadeIn 0.4s ease-out forwards; }
    canvas { touch-action: none; }
    /* إجبار التاريخ على اتجاه محدد */
    .force-ltr { direction: ltr !important; unicode-bidi: isolate; text-align: left; }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased overflow-hidden">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useRef, useEffect } = React;

    const DEVELOPER = {
        name: "أ. عمر بن حسن العطاس",
        twitterHandle: "@omer_attas", 
        twitterUrl: "https://x.com/omer_attas"
    };

    const Icons = {
      Badge: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78 4 4 0 0 1 0-6.74Z"/></svg>,
      Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
      Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
      Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
      Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
      ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
      Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
      Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
      Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
      Twitter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>,
      Text: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
      Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
      Pen: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    };

    // --- واجهة التعريف ---
    const WelcomeModal = ({ onClose }) => {
      return (
        <div className="fixed inset-0 z-[500] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-fade-up">
               <div className="bg-slate-800 p-6 text-white text-center">
                  <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Badge /></div>
                  <h2 className="text-2xl font-bold">الموثق الذكي Pro</h2>
                  <p className="text-slate-300 text-sm mt-1">تطوير: {DEVELOPER.name}</p>
               </div>
               <div className="p-8 space-y-6 text-right">
                  <div className="space-y-4">
                     <div className="flex items-start gap-4">
                        <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">1</div>
                        <div><h4 className="font-bold text-gray-800">تحميل المستند</h4><p className="text-sm text-gray-500">اختر ملف PDF المراد العمل عليه.</p></div>
                     </div>
                     <div className="flex items-start gap-4">
                        <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">2</div>
                        <div><h4 className="font-bold text-gray-800">التوقيع والتاريخ</h4><p className="text-sm text-gray-500">وقع يدوياً بلمسات ناعمة، أو أضف تاريخ اليوم بضغطة زر.</p></div>
                     </div>
                     <div className="flex items-start gap-4">
                        <div className="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-bold">3</div>
                        <div><h4 className="font-bold text-gray-800">الأتمتة</h4><p className="text-sm text-gray-500">استخدم ميزة "التكرار" لتوقيع كامل الملف دفعة واحدة.</p></div>
                     </div>
                  </div>
                  <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl font-bold shadow-lg transition-all">ابدأ الاستخدام</button>
               </div>
            </div>
        </div>
      );
    };

    const renderPage = async (pdf, pageNumber) => {
      const page = await pdf.getPage(pageNumber);
      const scale = 2.0; 
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d', { willReadFrequently: true });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      return {
        dataUrl: canvas.toDataURL('image/jpeg', 0.9),
        width: viewport.width,
        height: viewport.height,
        aspectRatio: viewport.width / viewport.height,
        originalFormat: [viewport.width / scale, viewport.height / scale]
      };
    };

    const textToImage = (text, color, fontSize, fontFamily) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const fontString = `bold ${fontSize * 2}px "${fontFamily}", sans-serif`;
        ctx.font = fontString;
        const metrics = ctx.measureText(text);
        const width = Math.ceil(metrics.width + 40);
        const height = Math.ceil((fontSize * 2) * 1.5);
        canvas.width = width;
        canvas.height = height;
        ctx.font = fontString;
        ctx.fillStyle = color;
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 20, height / 2);
        return {
            dataUrl: canvas.toDataURL('image/png'),
            width: width / 2, 
            height: height / 2 
        };
    };

    // --- نافذة التوقيع (تم إصلاح تقطع الخط نهائياً) ---
    const SignatureModal = ({ onClose, onSave }) => {
        const canvasRef = useRef(null);
        const [isDrawing, setIsDrawing] = useState(false);
        const [penColor, setPenColor] = useState('#2563eb');

        const getPos = (e) => {
            const canvas = canvasRef.current;
            const rect = canvas.getBoundingClientRect();
            const clientX = (e.clientX || (e.touches && e.touches[0].clientX));
            const clientY = (e.clientY || (e.touches && e.touches[0].clientY));
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        };

        const startDrawing = (e) => {
            e.preventDefault();
            const pos = getPos(e);
            setIsDrawing(true);
            const ctx = canvasRef.current.getContext('2d');
            
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = penColor;
            
            // نبدأ المسار هنا مرة واحدة فقط
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        };

        const draw = (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            const ctx = canvasRef.current.getContext('2d');
            
            // توصيل المسار الحالي بالنقطة الجديدة
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        };

        const stopDrawing = () => {
            if (isDrawing) {
                setIsDrawing(false);
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
            }
        };

        const clearCanvas = () => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        const handleSave = () => {
            const canvas = canvasRef.current;
            const dataUrl = canvas.toDataURL('image/png');
            onSave(dataUrl);
            onClose();
        };

        return (
            <div className="fixed inset-0 z-[600] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-fade-up">
                    <div className="bg-slate-800 p-4 text-white flex justify-between items-center">
                        <h3 className="font-bold">رسم التوقيع (خط متصل)</h3>
                        <button onClick={onClose} className="text-white/70 hover:text-white">✕</button>
                    </div>
                    <div className="bg-gray-50 p-2 flex justify-center gap-3 border-b">
                        <span className="text-xs text-gray-500 self-center font-bold">لون القلم:</span>
                        {['#2563eb', '#000000', '#dc2626', '#16a34a'].map(c => (
                            <div key={c} onClick={() => setPenColor(c)} className={`w-6 h-6 rounded-full cursor-pointer border-2 shadow-sm transition-transform ${penColor === c ? 'border-slate-800 scale-125 ring-2 ring-blue-100' : 'border-white'}`} style={{background: c}}></div>
                        ))}
                    </div>
                    <div className="p-4 bg-gray-100 flex justify-center">
                        <canvas ref={canvasRef} width={500} height={250} className="bg-white rounded-xl shadow-inner border border-gray-300 touch-none w-full max-w-[500px]" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} />
                    </div>
                    <div className="p-4 flex gap-3 border-t bg-white">
                        <button onClick={clearCanvas} className="flex-1 py-2 text-slate-600 font-bold border rounded-lg hover:bg-slate-50">مسح</button>
                        <button onClick={handleSave} className="flex-1 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-700">اعتماد التوقيع</button>
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {
      const [showWelcome, setShowWelcome] = useState(true);
      const [showSignatureModal, setShowSignatureModal] = useState(false);
      const [step, setStep] = useState(1); 
      const [file, setFile] = useState(null);
      const [pages, setPages] = useState([]); 
      const [currentPage, setCurrentPage] = useState(0);
      const [processingStats, setStats] = useState({ current: 0, total: 0 });
      const [elements, setElements] = useState([]); 
      const [activeElementId, setActiveElementId] = useState(null);
      const [library, setLibrary] = useState(() => {
        try {
            const saved = localStorage.getItem('my_stamps_library_v2'); 
            return saved ? JSON.parse(saved) : [];
        } catch (e) { return []; }
      });
      const [dragState, setDragState] = useState({ isDragging: false, startX: 0, startY: 0, initialElX: 0, initialElY: 0 });
      const imageContainerRef = useRef(null);
      const fileInputRef = useRef(null);

      // --- أتمتة التاريخ المنسق (يوم-شهر-سنة) ---
      const addDateElement = () => {
          const today = new Date();
          const d = String(today.getDate()).padStart(2, '0');
          const m = String(today.getMonth() + 1).padStart(2, '0');
          const y = today.getFullYear();
          
          // نص التاريخ الصافي
          const formattedDate = d + "-" + m + "-" + y;
          
          const newEl = { 
            id: Date.now(), 
            type: 'text', 
            text: formattedDate, 
            color: '#000000', 
            fontSize: 24, 
            fontFamily: 'Cairo', 
            x: 50, 
            y: 50, 
            width: 30, 
            pageIndex: currentPage, 
            isRepeated: false,
            isDate: true // ميزناه كعنصر تاريخ
          };
          setElements(prev => [...prev, newEl]);
          setActiveElementId(newEl.id);
      };

      const addToLibrary = (src) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 300; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = img.width > MAX_WIDTH ? MAX_WIDTH : img.width;
            canvas.height = img.width > MAX_WIDTH ? img.height * scale : img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const compressedSrc = canvas.toDataURL('image/png');
            if (library.includes(compressedSrc)) return alert("موجود مسبقاً");
            try {
                const newLib = [...library, compressedSrc];
                setLibrary(newLib);
                localStorage.setItem('my_stamps_library_v2', JSON.stringify(newLib));
                alert("تم الحفظ في المكتبة");
            } catch (e) { alert("المكتبة ممتلئة"); }
        };
      };

      const removeFromLibrary = (index) => {
        if (!confirm("حذف؟")) return;
        const newLib = library.filter((_, i) => i !== index);
        setLibrary(newLib);
        localStorage.setItem('my_stamps_library_v2', JSON.stringify(newLib));
      };

      const addFromLibrary = (src) => {
        const newEl = { id: Date.now(), type: 'image', src, x: 50, y: 50, width: 20, pageIndex: currentPage, isRepeated: false };
        setElements(prev => [...prev, newEl]);
        setActiveElementId(newEl.id);
      };

      const handleDrawnSignature = (src) => {
          const newEl = { id: Date.now(), type: 'image', src, x: 50, y: 50, width: 25, pageIndex: currentPage, isRepeated: false };
          setElements(prev => [...prev, newEl]);
          setActiveElementId(newEl.id);
      };

      const addTextElement = () => {
          const newEl = { id: Date.now(), type: 'text', text: 'نص جديد', color: '#000000', fontSize: 24, fontFamily: 'Cairo', x: 50, y: 50, width: 30, pageIndex: currentPage, isRepeated: false, isDate: false };
          setElements(prev => [...prev, newEl]);
          setActiveElementId(newEl.id);
      };

      const handleReset = () => {
        if (elements.length > 0 && !confirm("هل أنت متأكد؟")) return;
        setFile(null); setPages([]); setElements([]); setActiveElementId(null); setStep(1); setCurrentPage(0);
      };

      const handleFileSelect = (e) => { if (e.target.files?.[0]) setFile(e.target.files[0]); };

      const startLoading = async () => {
        if (!file) return;
        setStep(2);
        try {
          const arrayBuffer = await file.arrayBuffer();
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/', cMapPacked: true });
          const pdf = await loadingTask.promise;
          const numPages = pdf.numPages;
          const loadedPages = [];
          for (let i = 1; i <= numPages; i++) {
            setStats({ current: i, total: numPages });
            const pageData = await renderPage(pdf, i);
            loadedPages.push(pageData);
          }
          setPages(loadedPages);
          setStep(3);
        } catch (err) { alert("خطأ: " + err.message); setStep(1); }
      };

      const handleAddImageFile = (e) => {
        if (e.target.files?.[0]) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const src = ev.target.result;
            const newEl = { id: Date.now(), type: 'image', src, x: 50, y: 50, width: 20, pageIndex: currentPage, isRepeated: false };
            setElements(prev => [...prev, newEl]);
            setActiveElementId(newEl.id);
            e.target.value = '';
          };
          reader.readAsDataURL(e.target.files[0]);
        }
      };

      const updateActiveElement = (key, value) => {
        if (!activeElementId) return;
        setElements(prev => prev.map(el => el.id === activeElementId ? { ...el, [key]: value } : el));
      };

      const deleteActiveElement = () => {
        if (!activeElementId) return;
        setElements(prev => prev.filter(el => el.id !== activeElementId));
        setActiveElementId(null);
      };

      const handlePointerDown = (e, id) => {
        e.stopPropagation(); e.preventDefault();
        const el = elements.find(s => s.id === id);
        if (!el) return;
        setActiveElementId(id);
        setDragState({ isDragging: true, startX: e.clientX, startY: e.clientY, initialElX: el.x, initialElY: el.y });
      };

      const handlePointerMove = useCallback((e) => {
        if (!dragState.isDragging || !activeElementId || !imageContainerRef.current) return;
        e.preventDefault();
        const rect = imageContainerRef.current.getBoundingClientRect();
        const deltaX = e.clientX - dragState.startX;
        const deltaY = e.clientY - dragState.startY;
        const deltaPercentX = (deltaX / rect.width) * 100;
        const deltaPercentY = (deltaY / rect.height) * 100;
        let newX = Math.max(0, Math.min(100, dragState.initialElX + deltaPercentX));
        let newY = Math.max(0, Math.min(100, dragState.initialElY + deltaPercentY));
        setElements(prev => prev.map(el => el.id === activeElementId ? { ...el, x: newX, y: newY } : el));
      }, [dragState, activeElementId]);

      const handlePointerUp = () => setDragState(prev => ({ ...prev, isDragging: false }));

      useEffect(() => {
        if (dragState.isDragging) {
          window.addEventListener('pointermove', handlePointerMove);
          window.addEventListener('pointerup', handlePointerUp);
        }
        return () => {
          window.removeEventListener('pointermove', handlePointerMove);
          window.removeEventListener('pointerup', handlePointerUp);
        };
      }, [dragState.isDragging, handlePointerMove]);

      const saveFinalPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'pt' }); 
        doc.deletePage(1);
        pages.forEach((pageData, index) => {
          const isLandscape = pageData.width > pageData.height;
          const [width, height] = pageData.originalFormat;
          doc.addPage([width, height], isLandscape ? 'l' : 'p');
          doc.addImage(pageData.dataUrl, 'JPEG', 0, 0, width, height);
          const pageElements = elements.filter(el => el.pageIndex === index || el.isRepeated);
          pageElements.forEach(el => {
              if (el.type === 'text') {
                  const textImg = textToImage(el.text, el.color, el.fontSize, el.fontFamily);
                  const ratio = textImg.width / textImg.height;
                  const finalH = el.fontSize * 1.5; 
                  const finalW = finalH * ratio;
                  const pdfX = (el.x / 100) * width - (finalW / 2);
                  const pdfY = (el.y / 100) * height - (finalH / 2);
                  doc.addImage(textImg.dataUrl, 'PNG', pdfX, pdfY, finalW, finalH);
              } else {
                  const imgProps = doc.getImageProperties(el.src);
                  const sigW = (el.width / 100) * width;
                  const sigH = (imgProps.height * sigW) / imgProps.width;
                  const sigX = (el.x / 100) * width - (sigW / 2);
                  const sigY = (el.y / 100) * height - (sigH / 2);
                  doc.addImage(el.src, 'PNG', sigX, sigY, sigW, sigH);
              }
          });
        });
        doc.save(`Signed_${Date.now()}.pdf`);
      };

      const activeElementData = elements.find(el => el.id === activeElementId);
      const currentPageData = pages[currentPage];

      return (
        <div className="h-screen flex flex-col bg-slate-200 overflow-hidden">
           {showWelcome && <WelcomeModal onClose={() => setShowWelcome(false)} />}
           {showSignatureModal && <SignatureModal onClose={() => setShowSignatureModal(false)} onSave={handleDrawnSignature} />}
           
           <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
              {step === 1 && (
                <div className="w-full flex items-center justify-center p-4">
                  <div className="bg-white max-w-md w-full rounded-2xl shadow-xl p-8 space-y-6 text-center border-t-4 border-slate-800">
                      <div className="w-16 h-16 bg-slate-100 text-slate-800 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Badge /></div>
                      <h1 className="text-2xl font-bold text-gray-800">برنامج الموثق</h1>
                      <div className="space-y-4">
                        <label className="block bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-8 cursor-pointer hover:bg-slate-100 transition-colors">
                          <input type="file" onChange={handleFileSelect} accept="application/pdf" className="hidden" />
                          <Icons.Upload />
                          <span className="block mt-2 font-medium text-slate-600">{file ? file.name : "اضغط لاختيار ملف PDF"}</span>
                        </label>
                        {file && <button onClick={startLoading} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition-all">بدء العمل</button>}
                      </div>
                  </div>
                </div>
              )}
              {step === 2 && (
                <div className="w-full flex items-center justify-center">
                   <div className="text-center">
                      <div className="w-16 h-16 border-4 border-slate-800 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                      <h2 className="text-xl font-bold">جاري تجهيز الصفحات...</h2>
                      <p className="text-gray-500 dir-ltr">{processingStats.current} / {processingStats.total}</p>
                   </div>
                </div>
              )}
              {step === 3 && (
                <>
                  <div className="w-full md:w-80 bg-white border-l border-gray-300 p-4 flex flex-col gap-4 z-20 shadow-lg overflow-y-auto h-1/3 md:h-full shrink-0">
                    <div className="flex items-center justify-between text-slate-800 font-bold text-lg border-b pb-2">
                      <span className="flex items-center gap-2"><Icons.Badge /> أدوات التحكم</span>
                      <button onClick={handleReset} className="text-xs bg-red-50 text-red-600 px-2 py-1 rounded flex items-center gap-1 hover:bg-red-100"><Icons.Refresh /> جديد</button>
                    </div>
                    
                    <div className="bg-slate-50 rounded-xl p-3 border">
                      <h3 className="text-xs font-bold text-slate-500 mb-2">مكتبة التواقيع</h3>
                      {library.length === 0 ? <p className="text-[10px] text-center text-gray-400">فارغة</p> : (
                        <div className="flex gap-2 overflow-x-auto library-scroll pb-2">
                            {library.map((src, idx) => (
                              <div key={idx} className="relative shrink-0 group">
                                <img src={src} className="w-12 h-12 object-contain bg-white border rounded cursor-pointer hover:border-blue-500" onClick={() => addFromLibrary(src)} />
                                <button onClick={() => removeFromLibrary(idx)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100">×</button>
                              </div>
                            ))}
                        </div>
                      )}
                    </div>

                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={() => setShowSignatureModal(true)} className="py-2 border border-slate-300 text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px] transition-colors shadow-sm">
                                <Icons.Pen /> رسم توقيع
                            </button>
                            <button onClick={() => fileInputRef.current?.click()} className="py-2 border border-slate-300 text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px] transition-colors shadow-sm">
                                <input ref={fileInputRef} type="file" accept="image/*" onChange={handleAddImageFile} className="hidden" />
                                <Icons.Plus /> رفع صورة
                            </button>
                            <button onClick={addTextElement} className="py-2 border border-slate-300 text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px] transition-colors shadow-sm">
                                <Icons.Text /> إضافة نص
                            </button>
                            <button onClick={addDateElement} className="py-2 border border-blue-200 text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px] transition-colors shadow-md">
                                <Icons.Calendar /> تاريخ اليوم
                            </button>
                        </div>

                      {activeElementId && activeElementData ? (
                        <div className="bg-slate-50 p-3 rounded-xl border space-y-3 animate-fade-in shadow-sm">
                          <div className="flex justify-between items-center text-sm font-bold text-gray-700 border-b pb-2">
                            <span>خصائص: {activeElementData.type === 'text' ? 'النص' : 'الصورة'}</span>
                            <button onClick={deleteActiveElement} className="text-red-500 bg-red-50 p-1.5 rounded hover:bg-red-100"><Icons.Trash /></button>
                          </div>
                          {activeElementData.type === 'image' && (
                            <button onClick={() => addToLibrary(activeElementData.src)} className="w-full text-xs bg-slate-200 text-slate-700 py-1 rounded hover:bg-slate-300 flex items-center justify-center gap-1"><Icons.Save /> حفظ في المكتبة</button>
                          )}
                          <button onClick={() => updateActiveElement('isRepeated', !activeElementData.isRepeated)} className={`w-full py-2 px-3 rounded-lg text-xs font-bold flex items-center justify-between transition-colors ${activeElementData.isRepeated ? 'bg-amber-100 text-amber-800 border border-amber-200' : 'bg-white border text-gray-500 hover:bg-gray-50'}`}>
                            <span className="flex items-center gap-2"><Icons.Copy /> {activeElementData.isRepeated ? "التكرار مفعل" : "تكرار على الكل"}</span>
                            <div className={`w-8 h-4 rounded-full relative transition-colors ${activeElementData.isRepeated ? 'bg-amber-500' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded-full absolute top-0.5 transition-all ${activeElementData.isRepeated ? 'left-4' : 'left-0.5'}`}></div></div>
                          </button>
                          {activeElementData.type === 'text' && (
                              <>
                                <div><label className="text-xs text-gray-500 mb-1 block">النص</label><input type="text" value={activeElementData.text} onChange={(e) => updateActiveElement('text', e.target.value)} className="w-full p-2 text-sm border rounded" /></div>
                                <div><label className="text-xs text-gray-500 mb-1 block">نوع الخط</label>
                                    <select value={activeElementData.fontFamily} onChange={(e) => updateActiveElement('fontFamily', e.target.value)} className="w-full p-2 text-sm border rounded bg-white">
                                        <option value="Cairo">Cairo</option><option value="Amiri">Amiri</option><option value="Arial">Arial</option>
                                    </select>
                                </div>
                                <div><label className="text-xs text-gray-500 mb-1 block">حجم الخط</label><input type="range" min="10" max="100" value={activeElementData.fontSize} onChange={(e) => updateActiveElement('fontSize', +e.target.value)} className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-700" /></div>
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">اللون</label>
                                    <div className="flex gap-2">
                                        {['#000000', '#dc2626', '#2563eb', '#16a34a'].map(c => (
                                            <div 
                                                key={c} 
                                                onClick={() => updateActiveElement('color', c)} 
                                                className={`w-6 h-6 rounded-full cursor-pointer border-2 shadow-sm ${activeElementData.color === c ? 'border-slate-800 scale-110' : 'border-gray-200'}`} 
                                                style={{background: c}}
                                            ></div>
                                        ))}
                                    </div>
                                </div>
                              </>
                          )}
                          {activeElementData.type === 'image' && (
                             <div><label className="text-xs text-gray-500 mb-1 block">الحجم</label><input type="range" min="5" max="80" value={activeElementData.width} onChange={(e) => updateActiveElement('width', +e.target.value)} className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-700" /></div>
                          )}
                        </div>
                      ) : (
                        <div className="text-center text-gray-400 text-xs py-2 border rounded-xl bg-gray-50">حدد عنصراً لتعديله</div>
                      )}
                    </div>
                    <div className="mt-auto space-y-2 pt-2 border-t">
                      <div className="flex items-center justify-between bg-slate-100 rounded-lg p-2">
                        <button onClick={() => setCurrentPage(p => Math.max(0, p - 1))} disabled={currentPage === 0} className="p-2 hover:bg-white rounded disabled:opacity-30"><Icons.ArrowRight /></button>
                        <span className="font-mono text-sm font-bold">ص {currentPage + 1} / {pages.length}</span>
                        <button onClick={() => setCurrentPage(p => Math.min(pages.length - 1, p + 1))} disabled={currentPage === pages.length - 1} className="p-2 hover:bg-white rounded disabled:opacity-30"><Icons.ArrowLeft /></button>
                      </div>
                      <button onClick={saveFinalPDF} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-md hover:bg-slate-700 flex items-center justify-center gap-2"><Icons.Download /> حفظ الملف</button>
                    </div>
                  </div>
                  <div className="flex-1 preview-bg relative overflow-auto flex items-center justify-center p-4 md:p-8 touch-none" onClick={() => setActiveElementId(null)}>
                    {currentPageData && (
                      <div ref={imageContainerRef} className="relative shadow-2xl bg-white transition-all select-none" style={{ width: currentPageData.aspectRatio > 1 ? '95%' : 'auto', height: currentPageData.aspectRatio > 1 ? 'auto' : '90vh', aspectRatio: `${currentPageData.aspectRatio}` }} onClick={(e) => e.stopPropagation()}>
                        <img src={currentPageData.dataUrl} className="w-full h-full object-contain pointer-events-none select-none block" draggable="false"/>
                        {elements.filter(el => el.pageIndex === currentPage || el.isRepeated).map(el => (
                          <div key={el.id} onPointerDown={(e) => handlePointerDown(e, el.id)} style={{ position: 'absolute', left: `${el.x}%`, top: `${el.y}%`, width: el.type === 'image' ? `${el.width}%` : 'auto', transform: 'translate(-50%, -50%)', zIndex: 50, cursor: 'grab', whiteSpace: 'nowrap' }} className={`draggable-item group rounded ${activeElementId === el.id ? 'active-element' : ''}`}>
                            {el.type === 'image' ? (
                                <img src={el.src} className="w-full h-full object-contain pointer-events-none select-none" draggable="false" />
                            ) : (
                                <div className={el.isDate ? "force-ltr" : ""} style={{ 
                                    fontSize: `${el.fontSize}px`, 
                                    color: el.color, 
                                    fontFamily: el.fontFamily, 
                                    fontWeight: 'bold',
                                    direction: el.isDate ? 'ltr' : 'inherit'
                                }}>{el.text}</div>
                            )}
                            {el.isRepeated && <div className="repeated-badge">تكرار</div>}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}
           </div>
           <div className="bg-slate-900 text-slate-400 text-xs py-2 px-4 flex justify-between items-center shrink-0">
              <div>برنامج الموثق الذكي Pro © 2025</div>
              <div className="flex items-center gap-3"><span>تطوير: {DEVELOPER.name}</span><a href={DEVELOPER.twitterUrl} target="_blank" className="hover:text-white transition-colors"><Icons.Twitter /></a></div>
           </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
